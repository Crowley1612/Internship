<template>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <Sidebar />
            <div class="col-md-10 p-4">
                <Header />
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1>C√†i ƒë·∫∑t</h1>
                </div>
                <div class="card shadow-sm p-4">
                    <a-tabs>
                        <!-- Account setting -->
                        <a-tab-pane key="1" tab="C√†i ƒë·∫∑t t√†i kho·∫£n">
                            <div class="profile-info-container">
                                <div class="profile-header">
                                    <div class="profile-picture"><span>üë§</span></div>
                                    <div class="profile-name">{{ user.name }}</div>
                                    <div class="verification">
                                        <i class="bi bi-check-lg"></i> ƒê√£ x√°c minh
                                    </div>
                                </div>

                                <div class="info-section">
                                    <div class="header">
                                        <h2>Th√¥ng tin c∆° b·∫£n</h2>
                                        <a-button type="primary" @click="showModal">
                                            <i class="bi bi-pencil-square"></i> Thay ƒë·ªïi th√¥ng tin
                                        </a-button>
                                    </div>
                                    <div class="info">
                                        <div><strong>H·ªç v√† t√™n:</strong> {{ user.name }}</div>
                                    </div>
                                    <div class="info">
                                        <div><strong>M√£ s·ªë thu·∫ø:</strong> {{ user.taxcode }}</div>
                                        <div><strong>C√¥ng ty:</strong> {{ user.company }}</div>
                                    </div>
                                </div>

                                <div class="info-section">
                                    <div class="header">
                                        <h2>Th√¥ng tin t√†i kho·∫£n</h2>
                                    </div>
                                    <div class="info">
                                        <div><strong>T√™n t√†i kho·∫£n:</strong> {{ user.username }}</div>
                                        <div class="email">
                                            <strong>Email:</strong> {{ user.email }} <span>‚úîÔ∏è</span>
                                        </div>
                                    </div>
                                    <div class="info">
                                        <div><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> {{ user.phone }}</div>
                                    </div>
                                </div>
                            </div>
                        </a-tab-pane>
                        <!-- Ph∆∞∆°ng th·ª©c k√Ω -->
                        <a-tab-pane key="2" tab="Ph∆∞∆°ng th·ª©c k√Ω">
                            <div class="container">
                                <div class="header">
                                    <h2>Th√¥ng tin ch·ªØ k√Ω s·ªë</h2>
                                </div>
                                <div class="info">
                                    <div>
                                        <label>Email:</label>
                                        <span>{{ user.email }}</span>
                                    </div>
                                    <div>
                                        <label>M√£ ƒëƒÉng k√Ω:</label>
                                        <span>{{ settings.registrationCode }}</span>
                                    </div>
                                </div>
                                <div class="info">
                                    <div>
                                        <label>Ng√†y h·∫øt h·∫°n CTS:</label>
                                        <span>08-07-2025 09:37:46</span>
                                    </div>
                                    <div>
                                        <label>Serial number:</label>
                                        <span>5402BC5ACCE669C202300000007A3</span>
                                    </div>
                                </div>
                                <div class="long-info">
                                    <label>Th√¥ng tin ch·ª©ng th∆∞ s·ªë:</label>
                                    <textarea readonly>
C=VN, ST=H√† N·ªôi, L=TDP VƒÉn Tr√¨ 4, Minh Khai, B·∫Øc T·ª´ Li√™m, H√† N·ªôi,
0.9.2342.19200300.100.1=CCCCD:001191009538, O=ƒê·ªó Th·ªã Thu H·∫±ng, E={{ user.email }}, CN=ƒê·ªó Th·ªã Thu H·∫±ng
                                    </textarea>
                                </div>
                            </div>
                            <div class="container">
                                <h2>C√†i ƒë·∫∑t ph∆∞∆°ng th·ª©c</h2>
                                <div class="section">
                                    <label>Ch·ªçn ph∆∞∆°ng th·ª©c k√Ω:</label>
                                    <div class="radio-group">
                                        <label>
                                            <input type="radio" name="signingMethod" value="usb"
                                                v-model="settings.signingMethod" />
                                            K√Ω b·∫±ng USB Token
                                        </label>
                                        <label>
                                            <input type="radio" name="signingMethod" value="remote"
                                                v-model="settings.signingMethod" />
                                            K√Ω b·∫±ng Remote Signing
                                        </label>
                                    </div>
                                    <label>M√£ ƒëƒÉng k√Ω:</label>
                                    <input type="text" v-model="settings.registrationCode" />
                                    <button class="update-button" @click="updateRegistrationCode">C·∫≠p nh·∫≠t</button>
                                </div>
                                <div class="section">
                                    <h2>C√†i ƒë·∫∑t hi·ªÉn th·ªã</h2>
                                    <div class="radio-group">
                                        <label>
                                            <input type="radio" name="displayMethod" value="displaySignature"
                                                v-model="settings.displayMethod" />
                                            Hi·ªÉn th·ªã ch·ªØ k√Ω s·ªë
                                        </label>
                                        <label>
                                            <input type="radio" name="displayMethod" value="displayImage"
                                                v-model="settings.displayMethod" />
                                            Hi·ªÉn th·ªã ·∫£nh
                                        </label>
                                        <label>
                                            <input type="radio" name="displayMethod" value="displayBoth"
                                                v-model="settings.displayMethod" />
                                            Hi·ªÉn th·ªã ·∫£nh v√† ch·ªØ k√Ω s·ªë
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </a-tab-pane>
                        <!-- ƒê·ªïi m·∫≠t kh·∫©u -->
                        <a-tab-pane key="3" tab="ƒê·ªïi m·∫≠t kh·∫©u">
                            <div class="change-password-container">
                                <h2>Thay ƒë·ªïi m·∫≠t kh·∫©u</h2>
                                <p>M·∫≠t kh·∫©u c·∫ßn c√≥ t·ªëi thi·ªÉu 6 k√Ω t·ª±, bao g·ªìm s·ªë, ch·ªØ c√°i th∆∞·ªùng, ch·ªØ in hoa, k√Ω t·ª± ƒë·∫∑c
                                    bi·ªát.</p>
                                <div class="form-change-pass">
                                    <a-form ref="formRef" name="custom-validation" :model="formState" :rules="rules"
                                        v-bind="layout" @finish="handleFinish" @validate="handleValidate"
                                        @finishFailed="handleFinishFailed">
                                        <!-- Old Password Field -->
                                        <label style="margin-right: 20px;">Nh·∫≠p m·∫≠t kh·∫©u c≈©:</label>
                                        <a-form-item has-feedback name="oldPass" style="margin-right: 20px;">
                                            <a-input v-model:value="formState.oldPass"
                                                type="password" autocomplete="off" />
                                        </a-form-item>

                                        <!-- Password Field -->
                                        <label style="margin-right: 20px;">M·∫≠t kh·∫©u m·ªõi:</label>
                                        <a-form-item has-feedback name="pass">
                                            <a-input v-model:value="formState.pass"
                                                type="password" autocomplete="off" />
                                        </a-form-item>

                                        <!-- Confirm Password Field -->
                                        <label style="margin-right: 20px;">X√°c nh·∫≠n m·∫≠t kh·∫©u:</label>
                                        <a-form-item has-feedback name="checkPass">
                                            <a-input v-model:value="formState.checkPass"
                                                type="password" autocomplete="off" />
                                        </a-form-item>

                                        <!-- Submit and Reset Button -->
                                        <a-form-item :wrapper-col="{ span: 14, offset: 4 }">
                                            <a-button style="margin-left: 0px;" @click="resetForm">Hu·ª∑</a-button>
                                            <a-button style="margin-left: 10px;" type="primary" html-type="submit">X√°c
                                                nh·∫≠n</a-button>
                                        </a-form-item>
                                    </a-form>
                                </div>
                            </div>
                        </a-tab-pane>
                    </a-tabs>
                </div>
            </div>
        </div>
        <a-modal title="Thay ƒë·ªïi th√¥ng tin" v-model:open="isModalOpen" @ok="handleOk" @cancel="handleCancelModal">
            <a-form layout="vertical">
                <a-form-item label="H·ªç v√† t√™n:">
                    <a-input v-model="editUser.name" @change="(e) => {
                        editUser.name = e.target.value;
                    }
                        " />
                </a-form-item>
                <a-form-item label="M√£ s·ªë thu·∫ø:">
                    <a-input v-model="editUser.taxcode" @change="(e) => {
                        editUser.taxcode = e.target.value;
                    }
                        " />
                </a-form-item>
                <a-form-item label="C√¥ng ty:">
                    <a-input v-model="editUser.company" @change="(e) => {
                        editUser.company = e.target.value;
                    }
                        " />
                </a-form-item>
                <a-form-item label="T√™n t√†i kho·∫£n:">
                    <a-input v-model="editUser.username" @change="(e) => {
                        editUser.username = e.target.value;
                    }
                        " />
                </a-form-item>
                <a-form-item label="S·ªë ƒëi·ªán tho·∫°i:">
                    <a-input v-model="editUser.phone" @change="(e) => {
                        editUser.phone = e.target.value;
                    }
                        " />
                </a-form-item>
            </a-form>
        </a-modal>
    </div>
</template>

<script setup>
import { onMounted, reactive, ref } from 'vue';
import axios from 'axios';
import Sidebar from '../layout/Sidebar.vue';
import Header from '../layout/Header.vue';

// Reactive states for settings and user
const settings = reactive({
    signingMethod: 'usb',
    registrationCode: '400196',
    displayMethod: 'displaySignature'
});

const user = reactive({
  email: '',
  username: '',
  name: '',
  phone: '',
  taxcode: '',
  company: ''
});

const formState = reactive({
    oldPass: '',
    pass: '',
    checkPass: ''
});
const loadUserInfo = async () => {
  try {
    const response = await axios.get('http://localhost:3003/users');
    const userData = response.data[0]; // Assuming you want the first user in the array

    // Populate the user reactive object with the fetched data
    user.email = userData.email;
    user.username = userData.username;
    user.name = userData.name;
    user.phone = userData.tel;
    user.taxcode = userData.tax;
    user.company = userData.org;
  } catch (error) {
    console.error('Error loading user information:', error);
  }
};
// Define ref for the form
const formRef = ref(null);

// Custom validation for Old Password
const validateOldPass = async (_rule, value) => {
    if (!value) return Promise.reject('Please input the old password');
    return Promise.resolve();
};

// Custom validation for Password complexity
const validatePasswordComplexity = (_rule, value) => {
    const minLength = 6;
    const hasNumber = /[0-9]/;
    const hasLowercase = /[a-z]/;
    const hasUppercase = /[A-Z]/;
    const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/;

    if (!value) return Promise.reject('Please input the password');
    if (value.length < minLength) return Promise.reject(`Password must be at least ${minLength} characters long`);
    if (!hasNumber.test(value)) return Promise.reject('Password must contain at least one number');
    if (!hasLowercase.test(value)) return Promise.reject('Password must contain at least one lowercase letter');
    if (!hasUppercase.test(value)) return Promise.reject('Password must contain at least one uppercase letter');
    if (!hasSpecialChar.test(value)) return Promise.reject('Password must contain at least one special character');

    return Promise.resolve();
};

// Custom validation for Confirm Password field
const validateConfirmPassword = async (_rule, value) => {
    if (!value) return Promise.reject('Please input the password again');
    if (value !== formState.pass) return Promise.reject("Passwords don't match");
    return Promise.resolve();
};

// Form validation rules
const rules = {
    oldPass: [{ required: true, validator: validateOldPass, trigger: 'change' }],
    pass: [
        { required: true, validator: validatePasswordComplexity, trigger: 'change' }
    ],
    checkPass: [{ validator: validateConfirmPassword, trigger: 'change' }],
};

// Form layout configuration
const layout = {
    labelCol: { span: 4 },
    wrapperCol: { span: 14 }
};

// Form submission handling
const handleFinish = values => {
    console.log('Form submitted successfully:', values);
};

const handleFinishFailed = errors => {
    console.log('Form submission failed:', errors);
};

// Reset form fields
const resetForm = () => {
    if (formRef.value) {
        formRef.value.resetFields();
    }
};

// Log form validation events
const handleValidate = (...args) => {
    console.log('Validation triggered:', args);
};

const loading = ref(false);
const isModalOpen = ref(false);
const editUser = reactive({ ...user });

function updateRegistrationCode() {
    alert('M√£ ƒëƒÉng k√Ω ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t: ' + settings.registrationCode);
}

function showModal() {
    Object.assign(editUser, user);
    isModalOpen.value = true;
}

async function handleOk() {
    console.log(editUser); // Check if the updated values are correct
    loading.value = true;
    try {
        // Simulate API call
        Object.assign(user, editUser);
        console.log('Updated user:', user);
        isModalOpen.value = false;
    } catch (error) {
        console.error(error);
    } finally {
        loading.value = false;
    }
}

function handleCancelModal() {
    isModalOpen.value = false;
}
onMounted(() => {
    loadUserInfo();
});
</script>


<style scoped>
@import '@/assets/MasterPage.css';
@import '@/assets/Setting.css';

.feedback-message {
    color: red;
    margin-top: 10px;
}
</style>